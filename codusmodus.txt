from textual import on
from textual.app import App, ComposeResult
from textual.containers import Container, Horizontal
from textual.widgets import Button, Input, Static
from textual.reactive import reactive
from time import time

class MessageBubble(Static):
    """–í–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º"""
    
    def __init__(self, content: str, is_user: bool = False):
        super().__init__()
        self.content = content
        self.is_user = is_user
    
    def compose(self) -> ComposeResult:
        """–°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è"""
        with Container(classes=f"message {'user' if self.is_user else 'bot'}"):
            yield Static(self.content, classes="message-content")

class ChatApp(App):
    """–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–∞—Ç–∞"""
    
    CSS = """
    Screen {
        background: $surface;
    }
    
    #chat-container {
        height: 85%;
        border: solid $accent;
        margin: 1;
        padding: 1;
        overflow-y: auto;
    }
    
    #input-container {
        height: 15%;
        dock: bottom;
        margin: 1;
    }
    
    #input-row {
        height: auto;
        margin-top: 1;
    }
    
    .message {
        margin: 1 0;
        width: 100%;
    }
    
    .message.bot {
        align: left middle;
    }
    
    .message.user {
        align: right middle;
    }
    
    .message-content {
        width: 70%;
        padding: 1 2;
        border: round $accent;
        background: $panel;
    }
    
    .message.user .message-content {
        background: $primary;
        color: white;
        margin-left: 1;
        margin-right: 0;
    }
    
    .message.bot .message-content {
        background: $success;
        color: white;
        margin-left: 0;
        margin-right: 1;
    }
    
    #message-input {
        width: 80%;
    }
    
    #send-button {
        width: 18%;
        margin-left: 1;
    }
    """
    
    current_input = reactive("")
    
    current_input = reactive("")
    
    def compose(self) -> ComposeResult:
        """–°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        yield Container(
            Static("ü§ñ –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π —á–∞—Ç", classes="header"),
            Container(id="chat-container"),
            Container(
                Horizontal(
                    Input(placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...", id="message-input"),
                    Button("–û—Ç–ø—Ä–∞–≤–∏—Ç—å", variant="primary", id="send-button"),
                    id="input-row"
                ),
                id="input-container"
            )
        )
    
    def on_mount(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
        self.chat_container = self.query_one("#chat-container")
        self.message_input = self.query_one("#message-input")
        self.message_input.focus()
        
        # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        self.add_message("–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à —á–∞—Ç-–±–æ—Ç. –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!", False)
    
    def add_message(self, content: str, is_user: bool = False) -> None:
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç"""
        message = MessageBubble(content, is_user)
        self.chat_container.mount(message)
        message.scroll_visible()
    
    @on(Button.Pressed, "#send-button")
    def on_send_button(self) -> None:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å"""
        self.send_message()
    
    @on(Input.Submitted)
    def on_input_submitted(self) -> None:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞"""
        self.send_message()
    
    def send_message(self) -> None:
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ–≥–æ"""
        message_text = self.message_input.value.strip()
        
        if not message_text:
            return
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self.add_message(message_text, True)
        
        # –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        self.message_input.value = ""
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–∑–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤–∞—à—É –ª–æ–≥–∏–∫—É)
        self.process_message(message_text)
    
    def process_message(self, message: str) -> None:
        """
        –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
        –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–≤–æ—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.
        """
        # –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        self.set_timer(0.5, lambda: self.generate_response(message))
    
    def generate_response(self, user_message: str) -> None:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ—é)
        user_message_lower = user_message.lower()
        
        if "–ø—Ä–∏–≤–µ—Ç" in user_message_lower:
            response = "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —É –≤–∞—Å –¥–µ–ª–∞?"
        elif "–∫–∞–∫ –¥–µ–ª–∞" in user_message_lower:
            response = "–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –†–∞–±–æ—Ç–∞—é –≤ –∫–æ–Ω—Å–æ–ª–∏ :)"
        elif "–≤—Ä–µ–º—è" in user_message_lower:
            response = f"–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: {time()}"
        elif "–ø–æ–º–æ—â—å" in user_message_lower:
            response = "–Ø –ø—Ä–æ—Å—Ç–æ–π —á–∞—Ç-–±–æ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å –æ —á—ë–º-–Ω–∏–±—É–¥—å –µ—â—ë!"
        else:
            response = f"–í—ã —Å–∫–∞–∑–∞–ª–∏: '{user_message}'. –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!"
        
        self.add_message(response, False)

if __name__ == "__main__":
    app = ChatApp()
    app.run()
